# Ansible Role: mongodb
# File: /tasks/supervisor.yml
# Description: Supervisor fallback for MongoDB when systemd is missing

---
- name: Supervisor | Check if installed
  ansible.builtin.command: which supervisord
  register: supervisor_installed
  changed_when: false
  ignore_errors: true

- name: Supervisor | Install
  ansible.builtin.package:
    name: supervisor
    state: present
  when: supervisor_installed.rc != 0

- name: Supervisor | Ensure directory exists
  ansible.builtin.file:
    path: /etc/supervisor/conf.d
    state: directory
    mode: "0755"

- name: Supervisor | Set config
  ansible.builtin.template:
    src: mongodb_supervisor.conf.j2
    dest: /etc/supervisor/conf.d/mongod.conf
    owner: root
    group: root
    mode: "0644"
  register: mongodb_supervisor_conf

- name: Supervisor | Check if process is running
  ansible.builtin.command: pgrep supervisord
  register: mongodb_supervisor_check
  changed_when: false
  ignore_errors: true

- name: Supervisor | Start process if missing
  ansible.builtin.command: supervisord -c /etc/supervisord.conf
  when: mongodb_supervisor_check.rc != 0

- name: Supervisor | Update and start mongod
  ansible.builtin.shell: |
    supervisorctl -c /etc/supervisord.conf update
    supervisorctl -c /etc/supervisord.conf start mongod
  changed_when: false
  when: (mongodb_supervisor_conf is defined and mongodb_supervisor_conf.changed) or (mongodb_conf_set is defined and mongodb_conf_set.changed)
