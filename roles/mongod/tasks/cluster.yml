# Ansible Role: mongodb
# File: /tasks/cluster.yml
# Description: Managed by doc-sync workflow

---
# Ansible Tasks for MongoDB Clustered setup
- name: cluster | ensure mongod is started (systemd)
  ansible.builtin.service:
    name: mongod
    state: started
  when:
    - mongodb_is_systemd
    - mongodb_manage_service | default(true) | bool
  ignore_errors: true

- name: cluster | Supervisor fallback
  ansible.builtin.include_tasks: supervisor.yml
  when: not mongodb_is_systemd

- name: cluster | wait for mongod port
  ansible.builtin.wait_for:
    port: "{{ mongodb_net.port }}"
    timeout: 30
  when:
    - ansible_facts['virtualization_type'] | default('') != 'docker'
    - mongodb_manage_service | default(true) | bool

- name: cluster | check if hosts are in clustered
  ansible.builtin.command: >-
    mongosh --port {{ mongodb_net.port }} --quiet --eval 'db.isMaster().hosts'
  register: check_cluster
  changed_when: false
  ignore_errors: true

# # Get the replicaset status and then lookup the primary
#  hostname and save to a variable
# - name: Ensure replicaset is stable before beginning
#   community.mongodb.mongodb_status:
#     login_user: "{{ admin_user }}"
#     login_password: "{{ admin_user_password }}"
#     poll: 3
#     interval: 10
#   register: rs
#
# - name: Lookup PRIMARY replicaset member
#   set_fact:
#     primary: "{{ item.key.split('.')[0] }}"
#   loop: "{{ lookup('dict', rs.replicaset) }}"
#   when: "'PRIMARY' in item.value"

- name: cluster | set fact
  ansible.builtin.set_fact:
    check_cluster: "{{ check_cluster.stdout }}"

- block:
    - name: cluster | create dict of cluster check
      ansible.builtin.set_fact:
        all_cluster_check: "{{ dict(keys|zip(values)) }}"
      vars:
        keys: "{{ ansible_play_hosts }}"
        values: "{{ ansible_play_hosts |
          map('extract', hostvars, ['check_cluster'])
          | list }}"

    - name: cluster | set fact when no host is clustered
      ansible.builtin.set_fact:
        no_host_is_clustered: false
      when: all_cluster_check.values() | list is not any

    - name: cluster | set fact when a host is not clustered
      ansible.builtin.set_fact:
        all_cluster_status: false
      when: all_cluster_check.values() | list is any

    - name: cluster | set fact when all hosts are in cluster
      ansible.builtin.set_fact:
        all_cluster_status: true
      when: all_cluster_check.values() | list is all

  run_once: true

- name: cluster | build member list
  ansible.builtin.set_fact:
    members: >-
      {{
        members | default([]) +
        [{
          'host': hostvars[item].ansible_fqdn + ':' + (hostvars[item].mongodb_net.port | default(mongodb_net.port) | string),
          'priority': hostvars[item].mongodb_priority | default(member_weight[hostvars[item].mongodb_replication_role])
        }]
      }}

  loop: "{{ ansible_play_hosts }}"
  run_once: true
  vars:
    member_weight:
      primary: 3
      secondary: 2
      arbiter: 1

- name: cluster | set fact for arbiter index number
  ansible.builtin.set_fact:
    arbiter_index: "{{ hostid }}"
  when: hostvars[item].mongodb_arbiter
  loop: "{{ ansible_play_hosts }}"
  loop_control:
    index_var: hostid

- name: cluster | block to initial build the replica set
  block:
    - name: cluster | set fact for initial replication
      ansible.builtin.set_fact:
        replication_init: true

    - name: cluster | set temporary conf
      ansible.builtin.template:
        src: mongod_init.conf.j2
        dest: /etc/mongod.conf
        owner: root
        group: root
        mode: "0644"

    - name: cluster | stop mongod before init (systemd)
      ansible.builtin.service:
        name: mongod
        state: stopped
      when: mongodb_is_systemd
      ignore_errors: true

    - name: cluster | stop mongod before init (supervisor)
      ansible.builtin.shell: |
        supervisorctl -c /etc/supervisord.conf stop mongod || true
        pkill mongod || true
      when: not mongodb_is_systemd
      ignore_errors: true

    - name: cluster | start mongod with init config
      ansible.builtin.command: "mongod --config /etc/mongod.conf --fork"
      changed_when: true
      ignore_errors: true

    - name: cluster | initial build
      community.mongodb.mongodb_replicaset:
        login_host: localhost
        login_port: "{{ mongodb_net.port }}"
        login_user: admin
        login_password: "{{ mongodb_admin_pass }}"
        replica_set: "{{ mongodb_replication.replSetName }}"
        members: "{{ members }}"
        arbiter_at_index: "{{ arbiter_index | default(omit) }}"
      when: mongodb_primary

    - name: cluster | wait until cluster health is ok
      community.mongodb.mongodb_status:
        login_port: "{{ mongodb_net.port }}"
        validate: default
        poll: 5
        interval: 12
        replica_set: "{{ mongodb_replication.replSetName }}"
      when: mongodb_primary

    - name: cluster | place original config
      ansible.builtin.template:
        src: mongod.conf.j2
        dest: /etc/mongod.conf
        owner: root
        group: root
        mode: "0644"

    - name: cluster | restart mongod service one by one (systemd)
      ansible.builtin.service:
        name: mongod
        state: restarted
      run_once: true
      delegate_to: "{{ item }}"
      loop: "{{ ansible_play_hosts }}"
      when: mongodb_is_systemd
      ignore_errors: true

    - name: cluster | restart mongod service one by one (supervisor)
      ansible.builtin.command: supervisorctl restart mongod
      run_once: true
      delegate_to: "{{ item }}"
      loop: "{{ ansible_play_hosts }}"
      when: not mongodb_is_systemd
      ignore_errors: true

    - name: cluster | wait until cluster health is ok
      community.mongodb.mongodb_status:
        login_host: localhost
        login_port: "{{ mongodb_net.port }}"
        login_user: admin
        login_password: "{{ mongodb_admin_pass }}"
        validate: minimal
        poll: 5
        interval: 12
        replica_set: "{{ mongodb_replication.replSetName }}"
      when: mongodb_primary

  when: no_host_is_clustered is defined
# - name: cluster | include scale playbook when applicable
#   include_tasks: scale.yml
#   when:
#     - all_cluster_status is defined and not all_cluster_status
#     - no_host_is_clustered is not defined
